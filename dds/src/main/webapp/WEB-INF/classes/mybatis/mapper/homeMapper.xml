<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fly.dds.mapper.HomeMapper">
    <select id="homeRoom" parameterType="map" resultType="com.fly.dds.domain.Home">
        <![CDATA[
			SELECT num, subject, addr1, room_type, avg_rating AS rating, review_count, price, thumbnail
			FROM (
			    SELECT r.num, r.subject, r.addr1, r.room_type, 
			           NVL(AVG(rr.rating) OVER (PARTITION BY r.num), 0) AS avg_rating, 
			           NVL(COUNT(rr.review_num) OVER (PARTITION BY r.num), 0) AS review_count, 
			           MIN(d.price) OVER (PARTITION BY r.num) AS price, 
			           r.thumbnail,
			           (NVL(AVG(rr.rating) OVER (PARTITION BY r.num), 0) * 0.7 + 
			           NVL(COUNT(rr.review_num) OVER (PARTITION BY r.num), 0) * 0.3) AS score,
			           ROW_NUMBER() OVER (PARTITION BY r.num ORDER BY r.num) AS rn
			    FROM room r
			    LEFT OUTER JOIN room_review rr ON r.num = rr.num
			    LEFT OUTER JOIN room_detail d ON r.num = d.num
			    WHERE r.active = 1
			)
			WHERE rn = 1
			ORDER BY score DESC
			FETCH FIRST 12 ROWS ONLY
        ]]>
    </select>
    
    <select id="homeCompanion" parameterType="map" resultType="com.fly.dds.domain.Companion">
		SELECT DISTINCT c.num, subject, nickname,region_main AS mainRegion, total_people
		FROM companion c
		JOIN companion_info ci ON c.num = ci.num
		JOIN companion_age ca ON c.num = ca.num
		JOIN companion_region cr ON c.num = cr.num
		JOIN member_profile m ON c.user_num = m.user_num
		ORDER BY dbms_random.value
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>
</mapper>

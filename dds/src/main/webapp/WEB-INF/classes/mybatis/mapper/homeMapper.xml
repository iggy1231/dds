<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fly.dds.mapper.HomeMapper">
    <select id="homeRoom" parameterType="map" resultType="com.fly.dds.domain.Home">
        <![CDATA[
		SELECT num, subject, addr1, room_type, rating, review_count, price, thumbnail, score
		FROM (
		    SELECT r.num, r.subject, r.addr1, r.room_type, 
		           NVL(AVG(rr.rating) OVER (PARTITION BY r.num), 0) AS rating, 
		           NVL(COUNT(rr.review_num) OVER (PARTITION BY r.num), 0) AS review_count, 
		           MIN(d.price) OVER (PARTITION BY r.num) AS price, 
		           r.thumbnail,
		           (NVL(AVG(rr.rating) OVER (PARTITION BY r.num), 0) * 0.7 + 
		           NVL(COUNT(rr.review_num) OVER (PARTITION BY r.num), 0) * 0.3) AS score,
		           ROWNUM AS rn
		    FROM room r
		    LEFT OUTER JOIN room_review rr ON r.num = rr.num
		    LEFT OUTER JOIN room_detail d ON r.num = d.num
		    WHERE r.active = 1
		)
		WHERE rn <= 6
		ORDER BY score DESC
        ]]>
    </select>
</mapper>
